@page "/sala/{RoomHash}"
@inject ApiService Api
@inject AuthStateService AuthState
@inject RoomHubService Hub
@inject NavigationManager Nav
@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>Sala ‚Äî Assista Junto</PageTitle>

<!-- Toast Notifications -->
<div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    @foreach (var toast in _toasts)
    {
        <div class="toast show align-items-center text-bg-info border-0 mb-2" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    üü¢ <strong>@toast.Message</strong>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" @onclick="() => DismissToast(toast.Id)"></button>
            </div>
        </div>
    }
</div>

@if (_room is null)
{
    <div class="d-flex justify-content-center mt-5"><p>Carregando sala...</p></div>
}
else
{
    <div class="container-fluid mt-3">
        <div class="row">
            <!-- Player + Controles + Usu√°rios na sala -->
            <div class="col-lg-8">
                <h4>@_room.Name</h4>

                <div class="ratio ratio-16x9 mb-3 bg-dark rounded">
                    <div id="yt-player"></div>
                </div>

                <!-- Controles do player -->
                <div class="d-flex gap-2 mb-3 align-items-center">
                    <button class="btn btn-outline-secondary" @onclick="OnPrevious" title="Anterior">‚èÆ</button>
                    @if (_isPlaying)
                    {
                        <button class="btn btn-outline-primary" @onclick="OnPause" title="Pausar">‚è∏</button>
                    }
                    else
                    {
                        <button class="btn btn-outline-primary" @onclick="OnPlay" title="Reproduzir">‚ñ∂</button>
                    }
                    <button class="btn btn-outline-secondary" @onclick="OnNext" title="Pr√≥ximo">‚è≠</button>

                    <span class="ms-3 text-muted small">Volume (local):</span>
                    <input type="range" min="0" max="100" @bind="_volume" @bind:event="oninput" @bind:after="OnVolumeChanged" style="width:120px" />
                    <button class="btn btn-outline-secondary btn-sm" @onclick="ToggleMute">@(_isMuted ? "üîá" : "üîä")</button>
                </div>

                <!-- Pessoas na sala -->
                <h5>üë• Na sala (@_roomUsers.Count)</h5>
                <div class="d-flex flex-wrap gap-2 mb-3">
                    @foreach (var user in _roomUsers)
                    {
                        <div class="d-flex align-items-center bg-light rounded-pill px-3 py-1 border">
                            @if (!string.IsNullOrEmpty(user.AvatarUrl))
                            {
                                <img src="@user.AvatarUrl" alt="" width="28" height="28" class="rounded-circle me-2" />
                            }
                            else
                            {
                                <span class="me-2">üë§</span>
                            }
                            <span class="fw-semibold small">@user.DisplayName</span>
                        </div>
                    }
                    @if (_roomUsers.Count == 0)
                    {
                        <span class="text-muted small">Nenhum usu√°rio na sala.</span>
                    }
                </div>
            </div>

            <!-- Playlist + Chat -->
            <div class="col-lg-4">
                <!-- Adicionar √† playlist -->
                <div class="input-group mb-3">
                    <input type="text" class="form-control" @bind="_youtubeUrl" placeholder="Cole o link do YouTube ou playlist..." disabled="@_isAddingVideos" />
                    <button class="btn btn-success" @onclick="AddVideo" disabled="@_isAddingVideos">
                        @if (_isAddingVideos)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                            <span>Carregando...</span>
                        }
                        else
                        {
                            <span>+ Adicionar</span>
                        }
                    </button>
                </div>
                @if (_isAddingVideos)
                {
                    <div class="alert alert-info d-flex align-items-center mb-3 py-2" role="alert">
                        <div class="spinner-border spinner-border-sm text-info me-2"></div>
                        <small>Buscando v√≠deos da playlist no YouTube, aguarde...</small>
                    </div>
                }

                <!-- Playlist -->
                <h5>üìã Playlist (@_playlist.Count v√≠deos)</h5>
                <div class="list-group mb-3" style="max-height:300px;overflow-y:auto">
                    @for (int i = 0; i < _playlist.Count; i++)
                    {
                        var idx = i;
                        var item = _playlist[i];
                        <button type="button" class="list-group-item list-group-item-action d-flex align-items-center @(i == _currentVideoIndex ? "active" : "")" @onclick="() => JumpToVideo(idx)">
                            <img src="@item.ThumbnailUrl" alt="" width="80" class="me-3 rounded" />
                            <div class="flex-grow-1 text-start">
                                <strong>@item.Title</strong>
                                <br /><small class="@(i == _currentVideoIndex ? "" : "text-muted")">Adicionado por @item.AddedByDisplayName</small>
                            </div>
                            <span class="btn btn-sm btn-outline-danger ms-2" @onclick="() => RemoveVideo(item.Id)" @onclick:stopPropagation="true">‚úï</span>
                        </button>
                    }
                </div>

                <!-- Chat -->
                <h5>üí¨ Chat</h5>
                <div class="border rounded p-2 mb-2 bg-light" style="height:300px;overflow-y:auto" @ref="_chatContainer">
                    @foreach (var msg in _chatMessages)
                    {
                        <div class="mb-2">
                            <img src="@msg.UserAvatarUrl" alt="" width="24" class="rounded-circle me-1" />
                            <strong>@msg.UserDisplayName</strong>
                            <small class="text-muted ms-1">@msg.SentAt.ToLocalTime().ToString("HH:mm")</small>
                            <div class="ms-4">@msg.Content</div>
                        </div>
                    }
                </div>
                <div class="input-group">
                    <input type="text" class="form-control" @bind="_chatInput" @onkeydown="OnChatKeyDown" placeholder="Digite uma mensagem..." />
                    <button class="btn btn-primary" @onclick="SendChat">Enviar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string RoomHash { get; set; } = "";

    private RoomModel? _room;
    private List<PlaylistItemModel> _playlist = [];
    private List<ChatMessageModel> _chatMessages = [];
    private List<RoomUserModel> _roomUsers = [];
    private List<ToastNotification> _toasts = [];
    private int _currentVideoIndex;
    private bool _isPlaying;
    private string? _currentVideoId;
    private string _youtubeUrl = "";
    private string _chatInput = "";
    private int _volume = 80;
    private bool _isMuted;
    private bool _playerInitialized;
    private bool _playerReady;
    private bool _isAddingVideos;
    private DotNetObjectReference<RoomPage>? _dotNetRef;
    private ElementReference _chatContainer;

    private DateTime _lastRemoteActionTime = DateTime.MinValue;
    private const int RemoteCooldownMs = 1500;
    private bool IsRemoteCooldown => (DateTime.UtcNow - _lastRemoteActionTime).TotalMilliseconds < RemoteCooldownMs;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthState.IsAuthenticated)
        {
            Nav.NavigateTo("/");
            return;
        }

        _room = await Api.GetRoomAsync(RoomHash);
        if (_room is null)
        {
            Nav.NavigateTo("/");
            return;
        }

        _playlist = _room.Playlist;
        _currentVideoIndex = _room.CurrentVideoIndex;
        _isPlaying = _room.IsPlaying;

        Hub.OnRoomStateReceived += OnRoomState;
        Hub.OnPlayerActionReceived += OnPlayerAction;
        Hub.OnChatMessageReceived += OnChatMessage;
        Hub.OnPlaylistUpdated += OnPlaylistItem;
        Hub.OnUserJoined += OnUserJoined;
        Hub.OnUserLeft += OnUserLeft;
        Hub.OnUserListReceived += OnUserListReceived;

        await Hub.ConnectAsync();
        await Hub.JoinRoomAsync(RoomHash);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_room is not null && !_playerInitialized)
        {
            _playerInitialized = true;
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("youtubePlayer.initialize", "yt-player", _dotNetRef);
            await JS.InvokeVoidAsync("youtubePlayer.setVolume", _volume);
        }
    }

    [JSInvokable]
    public async Task OnPlayerReady()
    {
        _playerReady = true;
        _lastRemoteActionTime = DateTime.UtcNow;

        if (_playlist.Count > 0 && _currentVideoIndex < _playlist.Count)
        {
            _currentVideoId = _playlist[_currentVideoIndex].VideoId;
            var startTime = _room?.CurrentTime ?? 0;

            if (_isPlaying)
                await JS.InvokeVoidAsync("youtubePlayer.loadVideo", _currentVideoId, startTime);
            else
                await JS.InvokeVoidAsync("youtubePlayer.cueVideo", _currentVideoId, startTime);
        }
    }

    [JSInvokable]
    public async Task OnPlayerStateChanged(int state)
    {
        switch (state)
        {
            case 0:
                _isPlaying = false;
                if (_currentVideoIndex < _playlist.Count - 1)
                    await OnNext();
                break;

            case 1:
                _isPlaying = true;
                if (!IsRemoteCooldown)
                {
                    var time = await JS.InvokeAsync<double>("youtubePlayer.getCurrentTime");
                    await Hub.SendPlayerActionAsync(RoomHash, new PlayerActionModel { Action = 0, SeekTime = time });
                }
                break;

            case 2:
                _isPlaying = false;
                if (!IsRemoteCooldown)
                {
                    var time = await JS.InvokeAsync<double>("youtubePlayer.getCurrentTime");
                    await Hub.SendPlayerActionAsync(RoomHash, new PlayerActionModel { Action = 1, SeekTime = time });
                }
                break;
        }

        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnPlayerSeeked(double seekTime)
    {
        if (!IsRemoteCooldown)
        {
            await Hub.SendPlayerActionAsync(RoomHash, new PlayerActionModel { Action = 2, SeekTime = seekTime });
        }
    }

    private async Task OnPlay()
    {
        await JS.InvokeVoidAsync("youtubePlayer.play");
    }

    private async Task OnPause()
    {
        await JS.InvokeVoidAsync("youtubePlayer.pause");
    }

    private async Task OnNext()
    {
        await Hub.SendPlayerActionAsync(RoomHash, new PlayerActionModel { Action = 4 });
        await Hub.SyncStateAsync(RoomHash);
    }

    private async Task OnPrevious()
    {
        await Hub.SendPlayerActionAsync(RoomHash, new PlayerActionModel { Action = 5 });
        await Hub.SyncStateAsync(RoomHash);
    }

    private async Task JumpToVideo(int index)
    {
        if (index == _currentVideoIndex) return;
        await Hub.JumpToVideoAsync(RoomHash, index);
    }

    private void OnRoomState(RoomStateModel state)
    {
        InvokeAsync(async () =>
        {
            _lastRemoteActionTime = DateTime.UtcNow;
            _currentVideoIndex = state.CurrentVideoIndex;
            _isPlaying = state.IsPlaying;
            _playlist = state.Playlist;

            if (_playerReady && state.VideoId is not null)
            {
                var startTime = state.CurrentTime > 0 ? state.CurrentTime : 0;

                if (_currentVideoId != state.VideoId)
                {
                    _currentVideoId = state.VideoId;
                    if (state.IsPlaying)
                        await JS.InvokeVoidAsync("youtubePlayer.loadVideo", _currentVideoId, startTime);
                    else
                        await JS.InvokeVoidAsync("youtubePlayer.cueVideo", _currentVideoId, startTime);
                }
                else
                {
                    if (startTime > 0)
                        await JS.InvokeVoidAsync("youtubePlayer.seekTo", startTime);

                    if (state.IsPlaying)
                        await JS.InvokeVoidAsync("youtubePlayer.play");
                    else
                        await JS.InvokeVoidAsync("youtubePlayer.pause");
                }
            }

            _currentVideoId = state.VideoId;
            StateHasChanged();
        });
    }

    private void OnPlayerAction(PlayerActionModel action)
    {
        InvokeAsync(async () =>
        {
            _lastRemoteActionTime = DateTime.UtcNow;

            switch (action.Action)
            {
                case 0:
                    _isPlaying = true;
                    if (action.SeekTime.HasValue)
                        await JS.InvokeVoidAsync("youtubePlayer.seekTo", action.SeekTime.Value);
                    await JS.InvokeVoidAsync("youtubePlayer.play");
                    break;
                case 1:
                    _isPlaying = false;
                    if (action.SeekTime.HasValue)
                        await JS.InvokeVoidAsync("youtubePlayer.seekTo", action.SeekTime.Value);
                    await JS.InvokeVoidAsync("youtubePlayer.pause");
                    break;
                case 2:
                    if (action.SeekTime.HasValue)
                        await JS.InvokeVoidAsync("youtubePlayer.seekTo", action.SeekTime.Value);
                    break;
                case 4:
                case 5:
                    await Hub.SyncStateAsync(RoomHash);
                    break;
            }

            StateHasChanged();
        });
    }

    private void OnChatMessage(ChatMessageModel message)
    {
        InvokeAsync(() =>
        {
            _chatMessages.Add(message);
            StateHasChanged();
        });
    }

    private void OnPlaylistItem(PlaylistItemModel item)
    {
        InvokeAsync(async () =>
        {
            var wasEmpty = _playlist.Count == 0;
            _playlist.Add(item);

            if (wasEmpty && _playerReady)
            {
                _lastRemoteActionTime = DateTime.UtcNow;
                _currentVideoIndex = 0;
                _currentVideoId = item.VideoId;
                await JS.InvokeVoidAsync("youtubePlayer.loadVideo", item.VideoId, 0);
            }

            StateHasChanged();
        });
    }

    private void OnUserJoined(RoomUserModel user)
    {
        InvokeAsync(async () =>
        {
            ShowToast($"{user.DisplayName} entrou na sala");
            StateHasChanged();
        });
    }

    private void OnUserLeft(string userName)
    {
        InvokeAsync(() =>
        {
            ShowToast($"{userName} saiu da sala");
            StateHasChanged();
        });
    }

    private void OnUserListReceived(List<RoomUserModel> users)
    {
        InvokeAsync(() =>
        {
            _roomUsers = users;
            StateHasChanged();
        });
    }

    private void ShowToast(string message)
    {
        var toast = new ToastNotification { Message = message };
        _toasts.Add(toast);
        _ = RemoveToastAfterDelay(toast.Id);
    }

    private async Task RemoveToastAfterDelay(Guid toastId)
    {
        await Task.Delay(4000);
        await InvokeAsync(() =>
        {
            _toasts.RemoveAll(t => t.Id == toastId);
            StateHasChanged();
        });
    }

    private void DismissToast(Guid toastId)
    {
        _toasts.RemoveAll(t => t.Id == toastId);
    }

    private async Task OnVolumeChanged()
    {
        await JS.InvokeVoidAsync("youtubePlayer.setVolume", _volume);
    }

    private async Task ToggleMute()
    {
        _isMuted = !_isMuted;
        if (_isMuted)
            await JS.InvokeVoidAsync("youtubePlayer.mute");
        else
            await JS.InvokeVoidAsync("youtubePlayer.unmute");
    }

    private async Task AddVideo()
    {
        if (string.IsNullOrWhiteSpace(_youtubeUrl)) return;

        _isAddingVideos = true;
        StateHasChanged();

        try
        {
            await Api.AddPlaylistByUrlAsync(RoomHash, _youtubeUrl);
            _youtubeUrl = "";
        }
        catch (Exception)
        {
            // Fallback silencioso ‚Äî os itens que j√° foram adicionados aparecem via SignalR
        }
        finally
        {
            _isAddingVideos = false;
            StateHasChanged();
        }
    }

    private async Task RemoveVideo(Guid itemId)
    {
        await Api.RemoveFromPlaylistAsync(RoomHash, itemId);
        _playlist.RemoveAll(p => p.Id == itemId);
    }

    private async Task SendChat()
    {
        if (string.IsNullOrWhiteSpace(_chatInput)) return;
        await Hub.SendChatMessageAsync(RoomHash, _chatInput);
        _chatInput = "";
    }

    private async Task OnChatKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await SendChat();
    }

    public async ValueTask DisposeAsync()
    {
        Hub.OnRoomStateReceived -= OnRoomState;
        Hub.OnPlayerActionReceived -= OnPlayerAction;
        Hub.OnChatMessageReceived -= OnChatMessage;
        Hub.OnPlaylistUpdated -= OnPlaylistItem;
        Hub.OnUserJoined -= OnUserJoined;
        Hub.OnUserLeft -= OnUserLeft;
        Hub.OnUserListReceived -= OnUserListReceived;

        await Hub.LeaveRoomAsync(RoomHash);

        if (_playerInitialized)
            await JS.InvokeVoidAsync("youtubePlayer.destroy");

        _dotNetRef?.Dispose();
    }
}
