@page "/sala/{RoomHash}"
@using AssistaJunto.Client.Components
@inject ApiService Api
@inject AuthStateService AuthState
@inject RoomHubService Hub
@inject NavigationManager Nav
@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>Sala â€” Assista Junto</PageTitle>

<!-- Toast Notifications -->
<div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    @foreach (var toast in _toasts)
    {
        <div class="custom-toast p-3 mb-2 d-flex align-items-center justify-content-between animate__animated animate__fadeInRight">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-info-circle-fill"></i>
                <span class="fw-medium">@toast.Message</span>
            </div>
            <button type="button" class="btn-close btn-close-white ms-3" @onclick="() => DismissToast(toast.Id)"></button>
        </div>
    }
</div>

@if (_room is null)
{
    <div class="d-flex flex-column justify-content-center align-items-center vh-100 bg-black">
        <div class="spinner-border text-primary mb-3"></div>
        <p class="text-muted text-uppercase fw-bold small">Sincronizando com a sala...</p>
    </div>
}
else
{
    <div class="container-fluid mt-3">
        <div class="row">
            <!-- Player + Controles + UsuÃ¡rios na sala -->
            <div class="col-lg-8">
                <h4 class="text-white fw-bold">@_room.Name</h4>

                <div class="ratio ratio-16x9 mb-3 bg-dark rounded">
                    <div id="yt-player"></div>
                </div>

                <!-- Controles do player -->
                <VideoControls IsPlaying="_isPlaying"
                               Volume="_volume"
                               IsMuted="_isMuted"
                               OnPlay="OnPlay"
                               OnPause="OnPause"
                               OnNext="OnNext"
                               OnPrevious="OnPrevious"
                               OnToggleMute="ToggleMute"
                               OnVolumeChanged="UpdateVolume" />

                <!-- Pessoas na sala -->
                <div class="d-flex flex-wrap gap-2 mb-3">
                    <UserList Users="_roomUsers" RoomOwner="@_room.OwnerDisplayName" />
                    @if (_roomUsers.Count == 0)
                    {
                        <span class="text-muted small">Nenhum usuÃ¡rio na sala.</span>
                    }
                </div>
            </div>

            <!-- Playlist + Chat -->
            <div class="col-lg-4" style="margin-top: 2.4rem">
                <!-- Adicionar Ã  playlist -->
                <div class="input-group mb-3">
                    <input type="text" class="form-control" @bind="_youtubeUrl" placeholder="Cole o link do YouTube ou playlist..." disabled="@_isAddingVideos" />
                    <button class="btn btn-success" @onclick="AddVideo" disabled="@_isAddingVideos" style="background-color:#1b6ec2">
                        @if (_isAddingVideos)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                            <span>Carregando...</span>
                        }
                        else
                        {
                            <span>+ Adicionar</span>
                        }
                    </button>
                </div>
                @if (_isAddingVideos)
                {
                    <div class="alert alert-info d-flex align-items-center mb-3 py-2" role="alert">
                        <div class="spinner-border spinner-border-sm text-info me-2"></div>
                        <small>Buscando vÃ­deo(s) no YouTube, aguarde...</small>
                    </div>
                }

                <!-- Playlist -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="text-white fw-bold mb-0">ðŸ“‹ Playlist (@_playlist.Count vÃ­deos)</h5>
                    @if (_playlist.Count > 0)
                    {
                        <button class="btn btn-outline-danger btn-sm" @onclick="ClearPlaylist" title="Limpar playlist">
                            ðŸ—‘ Limpar
                        </button>
                    }
                </div>
                <div class="list-group mb-3" style="max-height:300px;overflow-y:auto">
                    @for (int i = 0; i < _playlist.Count; i++)
                    {
                        var idx = i;
                        var item = _playlist[i];
                        <button type="button" class="list-group-item list-group-item-action d-flex align-items-center @(i == _currentVideoIndex ? "active" : "")" @onclick="() => JumpToVideo(idx)">
                            <img src="@item.ThumbnailUrl" alt="" width="80" class="me-3 rounded" />
                            <div class="flex-grow-1 text-start">
                                <strong>@item.Title</strong>
                                <br /><small class="@(i == _currentVideoIndex ? "" : "text-muted")">Adicionado por @item.AddedByDisplayName</small>
                            </div>
                            <span class="btn btn-sm btn-outline-danger ms-2" @onclick="() => RemoveVideo(item.Id)" @onclick:stopPropagation="true">âœ•</span>
                        </button>
                    }
                </div>

                <!-- Chat -->
                <div class="flex-grow-1">
                    <ChatRoom Messages="_chatMessages" OnSendMessage="HandleSendMessage" />
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string RoomHash { get; set; } = "";

    private RoomModel? _room;
    private List<PlaylistItemModel> _playlist = [];
    private List<ChatMessageModel> _chatMessages = [];
    private List<RoomUserModel> _roomUsers = [];
    private List<ToastNotification> _toasts = [];
    private int _currentVideoIndex;
    private bool _isPlaying;
    private string? _currentVideoId;
    private string _youtubeUrl = "";
    private string _chatInput = "";
    private int _volume = 80;
    private bool _isMuted;
    private bool _playerInitialized;
    private bool _playerReady;
    private bool _isAddingVideos;
    private DotNetObjectReference<RoomPage>? _dotNetRef;
    private ElementReference _chatContainer;

    private DateTime _lastRemoteActionTime = DateTime.MinValue;
    private const int RemoteCooldownMs = 1500;
    private bool IsRemoteCooldown => (DateTime.UtcNow - _lastRemoteActionTime).TotalMilliseconds < RemoteCooldownMs;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthState.IsAuthenticated)
        {
            Nav.NavigateTo("/");
            return;
        }

        _room = await Api.GetRoomAsync(RoomHash);
        if (_room is null)
        {
            Nav.NavigateTo("/");
            return;
        }

        _playlist = _room.Playlist;
        _currentVideoIndex = _room.CurrentVideoIndex;
        _isPlaying = _room.IsPlaying;

        Hub.OnRoomStateReceived += OnRoomState;
        Hub.OnPlayerActionReceived += OnPlayerAction;
        Hub.OnChatMessageReceived += OnChatMessage;
        Hub.OnPlaylistUpdated += OnPlaylistItem;
        Hub.OnPlaylistCleared += OnPlaylistCleared;
        Hub.OnUserJoined += OnUserJoined;
        Hub.OnUserLeft += OnUserLeft;
        Hub.OnUserListReceived += OnUserListReceived;

        await Hub.ConnectAsync();
        await Hub.JoinRoomAsync(RoomHash);
    }

    private async Task HandleSendMessage(string message)
    {
        await Hub.SendChatMessageAsync(RoomHash, message);
    }

    private async Task UpdateVolume(int newVolume)
    {
        _volume = newVolume;
        await OnVolumeChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_room is not null && !_playerInitialized)
        {
            _playerInitialized = true;
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("youtubePlayer.initialize", "yt-player", _dotNetRef);
            await JS.InvokeVoidAsync("youtubePlayer.setVolume", _volume);
        }
    }

    [JSInvokable]
    public async Task OnPlayerReady()
    {
        _playerReady = true;
        _lastRemoteActionTime = DateTime.UtcNow;

        if (_playlist.Count > 0 && _currentVideoIndex < _playlist.Count)
        {
            _currentVideoId = _playlist[_currentVideoIndex].VideoId;
            var startTime = _room?.CurrentTime ?? 0;

            if (_isPlaying)
                await JS.InvokeVoidAsync("youtubePlayer.loadVideo", _currentVideoId, startTime);
            else
                await JS.InvokeVoidAsync("youtubePlayer.cueVideo", _currentVideoId, startTime);
        }
    }

    [JSInvokable]
    public async Task OnPlayerStateChanged(int state)
    {
        switch (state)
        {
            case 0:
                _isPlaying = false;
                if (_currentVideoIndex < _playlist.Count - 1)
                    await OnNext();
                break;

            case 1:
                _isPlaying = true;
                if (!IsRemoteCooldown)
                {
                    var time = await JS.InvokeAsync<double>("youtubePlayer.getCurrentTime");
                    await Hub.SendPlayerActionAsync(RoomHash, new PlayerActionModel { Action = 0, SeekTime = time });
                }
                break;

            case 2:
                _isPlaying = false;
                if (!IsRemoteCooldown)
                {
                    var time = await JS.InvokeAsync<double>("youtubePlayer.getCurrentTime");
                    await Hub.SendPlayerActionAsync(RoomHash, new PlayerActionModel { Action = 1, SeekTime = time });
                }
                break;
        }

        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnPlayerSeeked(double seekTime)
    {
        if (!IsRemoteCooldown)
        {
            await Hub.SendPlayerActionAsync(RoomHash, new PlayerActionModel { Action = 2, SeekTime = seekTime });
        }
    }

    private async Task OnPlay()
    {
        await JS.InvokeVoidAsync("youtubePlayer.play");
    }

    private async Task OnPause()
    {
        await JS.InvokeVoidAsync("youtubePlayer.pause");
    }

    private async Task OnNext()
    {
        await Hub.SendPlayerActionAsync(RoomHash, new PlayerActionModel { Action = 4 });
        await Hub.SyncStateAsync(RoomHash);
    }

    private async Task OnPrevious()
    {
        await Hub.SendPlayerActionAsync(RoomHash, new PlayerActionModel { Action = 5 });
        await Hub.SyncStateAsync(RoomHash);
    }

    private async Task JumpToVideo(int index)
    {
        if (index == _currentVideoIndex) return;
        await Hub.JumpToVideoAsync(RoomHash, index);
    }

    private void OnRoomState(RoomStateModel state)
    {
        InvokeAsync(async () =>
        {
            _lastRemoteActionTime = DateTime.UtcNow;
            _currentVideoIndex = state.CurrentVideoIndex;
            _isPlaying = state.IsPlaying;
            _playlist = state.Playlist;

            if (_playerReady && state.VideoId is not null)
            {
                var startTime = state.CurrentTime > 0 ? state.CurrentTime : 0;

                if (_currentVideoId != state.VideoId)
                {
                    _currentVideoId = state.VideoId;
                    if (state.IsPlaying)
                        await JS.InvokeVoidAsync("youtubePlayer.loadVideo", _currentVideoId, startTime);
                    else
                        await JS.InvokeVoidAsync("youtubePlayer.cueVideo", _currentVideoId, startTime);
                }
                else
                {
                    if (startTime > 0)
                        await JS.InvokeVoidAsync("youtubePlayer.seekTo", startTime);

                    if (state.IsPlaying)
                        await JS.InvokeVoidAsync("youtubePlayer.play");
                    else
                        await JS.InvokeVoidAsync("youtubePlayer.pause");
                }
            }

            _currentVideoId = state.VideoId;
            StateHasChanged();
        });
    }

    private void OnPlayerAction(PlayerActionModel action)
    {
        InvokeAsync(async () =>
        {
            _lastRemoteActionTime = DateTime.UtcNow;

            switch (action.Action)
            {
                case 0:
                    _isPlaying = true;
                    if (action.SeekTime.HasValue)
                        await JS.InvokeVoidAsync("youtubePlayer.seekTo", action.SeekTime.Value);
                    await JS.InvokeVoidAsync("youtubePlayer.play");
                    break;
                case 1:
                    _isPlaying = false;
                    if (action.SeekTime.HasValue)
                        await JS.InvokeVoidAsync("youtubePlayer.seekTo", action.SeekTime.Value);
                    await JS.InvokeVoidAsync("youtubePlayer.pause");
                    break;
                case 2:
                    if (action.SeekTime.HasValue)
                        await JS.InvokeVoidAsync("youtubePlayer.seekTo", action.SeekTime.Value);
                    break;
                case 4:
                case 5:
                    await Hub.SyncStateAsync(RoomHash);
                    break;
            }

            StateHasChanged();
        });
    }

    private void OnChatMessage(ChatMessageModel message)
    {
        InvokeAsync(() =>
        {
            _chatMessages.Add(message);
            StateHasChanged();
        });
    }

    private void OnPlaylistItem(PlaylistItemModel item)
    {
        InvokeAsync(async () =>
        {
            var wasEmpty = _playlist.Count == 0;
            _playlist.Add(item);

            if (wasEmpty && _playerReady)
            {
                _lastRemoteActionTime = DateTime.UtcNow;
                _currentVideoIndex = 0;
                _currentVideoId = item.VideoId;
                await JS.InvokeVoidAsync("youtubePlayer.loadVideo", item.VideoId, 0);
            }

            StateHasChanged();
        });
    }

    private void OnPlaylistCleared()
    {
        InvokeAsync(async () =>
        {
            _playlist.Clear();
            _currentVideoIndex = 0;
            _currentVideoId = null;
            _isPlaying = false;

            if (_playerReady)
                await JS.InvokeVoidAsync("youtubePlayer.stop");

            StateHasChanged();
        });
    }

    private async Task ClearPlaylist()
    {
        await Api.ClearPlaylistAsync(RoomHash);
    }

    private void OnUserJoined(RoomUserModel user)
    {
        InvokeAsync(async () =>
        {
            ShowToast($"{user.DisplayName} entrou na sala");
            StateHasChanged();
        });
    }

    private void OnUserLeft(string userName)
    {
        InvokeAsync(() =>
        {
            ShowToast($"{userName} saiu da sala");
            StateHasChanged();
        });
    }

    private void OnUserListReceived(List<RoomUserModel> users)
    {
        InvokeAsync(() =>
        {
            _roomUsers = users;
            StateHasChanged();
        });
    }

    private void ShowToast(string message)
    {
        var toast = new ToastNotification { Message = message };
        _toasts.Add(toast);
        _ = RemoveToastAfterDelay(toast.Id);
    }

    private async Task RemoveToastAfterDelay(Guid toastId)
    {
        await Task.Delay(4000);
        await InvokeAsync(() =>
        {
            _toasts.RemoveAll(t => t.Id == toastId);
            StateHasChanged();
        });
    }

    private void DismissToast(Guid toastId)
    {
        _toasts.RemoveAll(t => t.Id == toastId);
    }

    private async Task OnVolumeChanged()
    {
        await JS.InvokeVoidAsync("youtubePlayer.setVolume", _volume);
    }

    private async Task ToggleMute()
    {
        _isMuted = !_isMuted;
        if (_isMuted)
            await JS.InvokeVoidAsync("youtubePlayer.mute");
        else
            await JS.InvokeVoidAsync("youtubePlayer.unmute");
    }

    private async Task AddVideo()
    {
        if (string.IsNullOrWhiteSpace(_youtubeUrl)) return;

        _isAddingVideos = true;
        StateHasChanged();

        try
        {
            await Api.AddPlaylistByUrlAsync(RoomHash, _youtubeUrl);
            _youtubeUrl = "";
        }
        catch (Exception)
        {
            ShowToast("NÃ£o foi possÃ­vel adicionar o vÃ­deo. Verifique o link e tente novamente.");
        }
        finally
        {
            _isAddingVideos = false;
            StateHasChanged();
        }
    }

    private async Task RemoveVideo(Guid itemId)
    {
        await Api.RemoveFromPlaylistAsync(RoomHash, itemId);
        _playlist.RemoveAll(p => p.Id == itemId);
    }

    private async Task SendChat()
    {
        if (string.IsNullOrWhiteSpace(_chatInput)) return;
        await Hub.SendChatMessageAsync(RoomHash, _chatInput);
        _chatInput = "";
    }

    private async Task OnChatKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await SendChat();
    }

    public async ValueTask DisposeAsync()
    {
        Hub.OnRoomStateReceived -= OnRoomState;
        Hub.OnPlayerActionReceived -= OnPlayerAction;
        Hub.OnChatMessageReceived -= OnChatMessage;
        Hub.OnPlaylistUpdated -= OnPlaylistItem;
        Hub.OnPlaylistCleared -= OnPlaylistCleared;
        Hub.OnUserJoined -= OnUserJoined;
        Hub.OnUserLeft -= OnUserLeft;
        Hub.OnUserListReceived -= OnUserListReceived;

        await Hub.LeaveRoomAsync(RoomHash);

        if (_playerInitialized)
            await JS.InvokeVoidAsync("youtubePlayer.destroy");

        _dotNetRef?.Dispose();
    }
}
